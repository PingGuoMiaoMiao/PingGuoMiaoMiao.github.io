---
title: "K-Means é¢œè‰²èšç±»ç®—æ³•å¼€å‘è®°å½•"
tag: "å¼€å‘"
date: "2025-11-20"
summary: "K-Means é¢œè‰²èšç±»ç®—æ³•å¼€å‘è®°å½•  ç›®å½• 1. é¡¹ç›®æ¦‚è¿° 2. å¼€å‘ç¯å¢ƒå‡†å¤‡ 3. ç®—æ³•åŸç† 4. å®ç°æ­¥éª¤ 5. æ ¸å¿ƒä»£ç è§£æ 6. åŠŸèƒ½æ‰©å±• 7. åº”ç”¨åœºæ™¯ 8. å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ --..."
status: "published"
readingTime: 45
---

# K-Means é¢œè‰²èšç±»ç®—æ³•å¼€å‘è®°å½•

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [å¼€å‘ç¯å¢ƒå‡†å¤‡](#å¼€å‘ç¯å¢ƒå‡†å¤‡)
3. [ç®—æ³•åŸç†](#ç®—æ³•åŸç†)
4. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)
5. [æ ¸å¿ƒä»£ç è§£æ](#æ ¸å¿ƒä»£ç è§£æ)
6. [åŠŸèƒ½æ‰©å±•](#åŠŸèƒ½æ‰©å±•)
7. [åº”ç”¨åœºæ™¯](#åº”ç”¨åœºæ™¯)
8. [å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)

---

## ğŸ“– é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ç›®æ ‡

å®ç°ä¸€ä¸ªå®Œæ•´çš„ K-Means èšç±»ç®—æ³•ï¼Œç”¨äºä»å›¾ç‰‡ä¸­æå–ä¸»è¦é¢œè‰²ï¼Œå¹¶åœ¨ç»ˆç«¯ä¸­å¯è§†åŒ–æ˜¾ç¤ºå‹ç¼©åçš„å›¾ç‰‡ã€‚

### æŠ€æœ¯æ ˆ

- **è¯­è¨€**: C è¯­è¨€ (C11 æ ‡å‡†)
- **å›¾ç‰‡å¤„ç†**: stb_image.h (å•å¤´æ–‡ä»¶åº“)
- **ç¼–è¯‘å·¥å…·**: GCC + Makefile
- **å¯è§†åŒ–**: ANSI è½¬ä¹‰åºåˆ—ï¼ˆ24ä½çœŸå½©è‰²ï¼‰

---

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£…å¿…è¦çš„å·¥å…·

```bash
# å®‰è£… GCC ç¼–è¯‘å™¨
sudo apt-get install gcc make

# éªŒè¯å®‰è£…
gcc --version
make --version
```

### 2. ä¸‹è½½å›¾ç‰‡å¤„ç†åº“

```bash
# åˆ›å»º include ç›®å½•
mkdir -p include

# ä¸‹è½½ stb_image.hï¼ˆå•å¤´æ–‡ä»¶å›¾ç‰‡åŠ è½½åº“ï¼‰
curl -o include/stb_image.h https://raw.githubusercontent.com/nothings/stb/master/stb_image.h
```

### 3. é¡¹ç›®ç›®å½•ç»“æ„

```
K-means/
â”œâ”€â”€ src/                    # æºä»£ç 
â”‚   â”œâ”€â”€ kmeans.h           # ç®—æ³•å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ kmeans.c           # ç®—æ³•å®ç°
â”‚   â”œâ”€â”€ image_loader.h     # å›¾ç‰‡åŠ è½½å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ image_loader.c     # å›¾ç‰‡åŠ è½½å®ç°
â”‚   â””â”€â”€ main.c             # ä¸»ç¨‹åº
â”œâ”€â”€ include/                # ç¬¬ä¸‰æ–¹åº“
â”‚   â””â”€â”€ stb_image.h        # å›¾ç‰‡åŠ è½½åº“
â”œâ”€â”€ images/                 # è¾“å…¥å›¾ç‰‡
â”œâ”€â”€ output/                 # è¾“å‡ºç›®å½•
â”œâ”€â”€ obj/                    # ç¼–è¯‘ä¸­é—´æ–‡ä»¶
â”œâ”€â”€ bin/                    # å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ Makefile               # ç¼–è¯‘é…ç½®
â””â”€â”€ README.md              # ä½¿ç”¨æ–‡æ¡£
```

---

## ğŸ§  ç®—æ³•åŸç†

### K-Means ç®—æ³•ç®€ä»‹

K-Means æ˜¯ä¸€ç§**æ— ç›‘ç£å­¦ä¹ **èšç±»ç®—æ³•ï¼Œç”¨äºå°†æ•°æ®åˆ†æˆ K ä¸ªç°‡ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼š

- **æ•°æ®ç‚¹**: å›¾ç‰‡ä¸­çš„æ¯ä¸ªåƒç´ ï¼ˆRGB é¢œè‰²å€¼ï¼‰
- **ç›®æ ‡**: æ‰¾åˆ° K ä¸ª"ä»£è¡¨é¢œè‰²"ï¼ˆè´¨å¿ƒï¼‰ï¼Œä½¿å¾—æ‰€æœ‰åƒç´ éƒ½èƒ½è¢«åˆ†é…åˆ°æœ€æ¥è¿‘çš„ä»£è¡¨é¢œè‰²
- **è·ç¦»åº¦é‡**: æ¬§å‡ é‡Œå¾—è·ç¦»ï¼ˆRGB ç©ºé—´ä¸­çš„é¢œè‰²è·ç¦»ï¼‰

### ç®—æ³•æµç¨‹

```
1. åˆå§‹åŒ–ï¼šéšæœºé€‰æ‹© K ä¸ªåƒç´ ä½œä¸ºåˆå§‹è´¨å¿ƒ
2. è¿­ä»£ç›´åˆ°æ”¶æ•›ï¼š
   a. åˆ†é…é˜¶æ®µï¼šå°†æ¯ä¸ªåƒç´ åˆ†é…ç»™æœ€è¿‘çš„è´¨å¿ƒ
   b. æ›´æ–°é˜¶æ®µï¼šé‡æ–°è®¡ç®—æ¯ä¸ªç°‡çš„è´¨å¿ƒï¼ˆå¹³å‡å€¼ï¼‰
   c. åˆ¤æ–­æ”¶æ•›ï¼šå¦‚æœè´¨å¿ƒç§»åŠ¨è·ç¦» < é˜ˆå€¼ï¼Œåœæ­¢è¿­ä»£
3. è¾“å‡ºï¼šK ä¸ªä¸»é¢œè‰²ï¼ˆè´¨å¿ƒï¼‰
```

### æ•°å­¦å…¬å¼

**è·ç¦»è®¡ç®—ï¼ˆæ¬§å‡ é‡Œå¾—è·ç¦»ï¼‰**ï¼š
```
distance = âˆš[(râ‚-râ‚‚)Â² + (gâ‚-gâ‚‚)Â² + (bâ‚-bâ‚‚)Â²]
```

**è´¨å¿ƒæ›´æ–°**ï¼š
```
centroid_r = (æ‰€æœ‰ç°‡å†…åƒç´ çš„ r å€¼ä¹‹å’Œ) / (ç°‡å†…åƒç´ æ•°é‡)
centroid_g = (æ‰€æœ‰ç°‡å†…åƒç´ çš„ g å€¼ä¹‹å’Œ) / (ç°‡å†…åƒç´ æ•°é‡)
centroid_b = (æ‰€æœ‰ç°‡å†…åƒç´ çš„ b å€¼ä¹‹å’Œ) / (ç°‡å†…åƒç´ æ•°é‡)
```

---

## ğŸš€ å®ç°æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå®šä¹‰æ•°æ®ç»“æ„

**æ–‡ä»¶**: `src/kmeans.h`

```c
// é¢œè‰²ç»“æ„ä½“ï¼ˆRGBï¼‰
typedef struct {
    unsigned char r, g, b;  // æ¯ä¸ªé€šé“ 0-255
} RgbaColor;

// å›¾ç‰‡ç»“æ„ä½“
typedef struct {
    RgbaColor* pixels;      // åƒç´ æ•°ç»„
    unsigned int width;      // å®½åº¦
    unsigned int height;     // é«˜åº¦
} Image;
```

**è®¾è®¡è¦ç‚¹**ï¼š
- ä½¿ç”¨ `unsigned char` å­˜å‚¨ RGB å€¼ï¼ˆ0-255ï¼‰
- `pixels` æ˜¯ä¸€ç»´æ•°ç»„ï¼ŒæŒ‰è¡Œå­˜å‚¨ï¼š`pixels[y * width + x]`

### ç¬¬äºŒæ­¥ï¼šå®ç°è·ç¦»è®¡ç®—å‡½æ•°

**æ–‡ä»¶**: `src/kmeans.c`

```c
double calc_dist(const RgbaColor* c1, const RgbaColor* c2) {
    double dr = (double)c1->r - (double)c2->r;
    double dg = (double)c1->g - (double)c2->g;
    double db = (double)c1->b - (double)c2->b;
    return sqrt(dr * dr + dg * dg + db * db);
}
```

**å…³é”®ç‚¹**ï¼š
- å¿…é¡»è½¬æ¢ä¸º `double` è¿›è¡Œè®¡ç®—ï¼Œé¿å…æº¢å‡º
- ä½¿ç”¨ `sqrt()` éœ€è¦é“¾æ¥æ•°å­¦åº“ `-lm`

### ç¬¬ä¸‰æ­¥ï¼šå®ç°è´¨å¿ƒåˆå§‹åŒ–

```c
void init_centroids(const Image* image, RgbaColor* centroids, unsigned int k) {
    srand(time(NULL));  // è®¾ç½®éšæœºç§å­
    for (unsigned int i = 0; i < k; i++) {
        unsigned int idx = rand() % (image->width * image->height);
        centroids[i] = image->pixels[idx];  // ä»å›¾ç‰‡ä¸­éšæœºé€‰æ‹©åƒç´ 
    }
}
```

**è®¾è®¡é€‰æ‹©**ï¼š
- ä½¿ç”¨ `time(NULL)` ä½œä¸ºéšæœºç§å­ï¼Œç¡®ä¿æ¯æ¬¡è¿è¡Œç»“æœä¸åŒ
- ä»å›¾ç‰‡ä¸­éšæœºé€‰æ‹©åƒç´ ï¼Œè€Œä¸æ˜¯éšæœºç”Ÿæˆé¢œè‰²ï¼ˆæ›´ç¬¦åˆå®é™…åˆ†å¸ƒï¼‰

### ç¬¬å››æ­¥ï¼šå®ç°æ ¸å¿ƒ K-Means ç®—æ³•

è¿™æ˜¯æœ€å¤æ‚çš„éƒ¨åˆ†ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

#### é˜¶æ®µ 1ï¼šåˆ†é…åƒç´ åˆ°æœ€è¿‘çš„è´¨å¿ƒ

```c
// å¯¹æ¯ä¸ªåƒç´ 
for (unsigned int i = 0; i < total; i++) {
    double min_dist = 1e30;  // åˆå§‹åŒ–ä¸ºå¾ˆå¤§çš„å€¼
    unsigned int best = 0;
    
    // æ‰¾åˆ°æœ€è¿‘çš„è´¨å¿ƒ
    for (unsigned int c = 0; c < k; c++) {
        double dist = calc_dist(&image->pixels[i], &centroids[c]);
        if (dist < min_dist) {
            min_dist = dist;
            best = c;
        }
    }
    
    labels[i] = best;  // è®°å½•åƒç´ å±äºå“ªä¸ªç°‡
    
    // ç´¯åŠ  RGB å€¼ï¼ˆç”¨äºåç»­è®¡ç®—å¹³å‡å€¼ï¼‰
    sum_r[best] += image->pixels[i].r;
    sum_g[best] += image->pixels[i].g;
    sum_b[best] += image->pixels[i].b;
    cluster_sizes[best]++;
}
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `unsigned int` ç´¯åŠ  RGB å€¼ï¼Œé¿å… `unsigned char` æº¢å‡º
- åŒæ—¶è®°å½•æ¯ä¸ªç°‡çš„å¤§å°ï¼Œç”¨äºè®¡ç®—å¹³å‡å€¼

#### é˜¶æ®µ 2ï¼šæ›´æ–°è´¨å¿ƒ

```c
// å¯¹æ¯ä¸ªç°‡
for (unsigned int c = 0; c < k; c++) {
    if (cluster_sizes[c] == 0) {
        // ç©ºç°‡å¤„ç†ï¼šé‡æ–°éšæœºåˆå§‹åŒ–
        unsigned int idx = rand() % total;
        centroids[c] = image->pixels[idx];
        continue;
    }
    
    // è®¡ç®—æ–°çš„è´¨å¿ƒï¼ˆå¹³å‡å€¼ï¼‰
    centroids[c].r = (unsigned char)(sum_r[c] / cluster_sizes[c]);
    centroids[c].g = (unsigned char)(sum_g[c] / cluster_sizes[c]);
    centroids[c].b = (unsigned char)(sum_b[c] / cluster_sizes[c]);
    
    // åˆ¤æ–­æ˜¯å¦æ”¶æ•›
    if (calc_dist(&old, &centroids[c]) > threshold) {
        settled = 0;  // æœªæ”¶æ•›
    }
}
```

**é‡è¦ç»†èŠ‚**ï¼š
- **ç©ºç°‡å¤„ç†**ï¼šå¦‚æœæŸä¸ªç°‡æ²¡æœ‰åƒç´ ï¼Œé‡æ–°éšæœºåˆå§‹åŒ–
- **ç±»å‹è½¬æ¢**ï¼šé™¤æ³•ç»“æœè½¬æ¢ä¸º `unsigned char`
- **æ”¶æ•›åˆ¤æ–­**ï¼šè´¨å¿ƒç§»åŠ¨è·ç¦»å°äºé˜ˆå€¼åˆ™è®¤ä¸ºæ”¶æ•›

### ç¬¬äº”æ­¥ï¼šå®ç°å›¾ç‰‡åŠ è½½

**æ–‡ä»¶**: `src/image_loader.c`

```c
#define STB_IMAGE_IMPLEMENTATION
#include "../include/stb_image.h"

int load_image(const char* filename, Image* image) {
    int width, height, channels;
    unsigned char* data = stbi_load(filename, &width, &height, &channels, 3);
    
    if (!data) {
        fprintf(stderr, "æ— æ³•åŠ è½½å›¾ç‰‡: %s\n", filename);
        return -1;
    }
    
    // åˆ†é…å†…å­˜
    unsigned int total = width * height;
    image->pixels = malloc(sizeof(RgbaColor) * total);
    
    // è½¬æ¢æ ¼å¼ï¼šstb_image è¿”å›çš„æ˜¯ RGBRGB... æ ¼å¼
    for (unsigned int i = 0; i < total; i++) {
        image->pixels[i].r = data[i * 3 + 0];
        image->pixels[i].g = data[i * 3 + 1];
        image->pixels[i].b = data[i * 3 + 2];
    }
    
    image->width = width;
    image->height = height;
    
    stbi_image_free(data);  // é‡Šæ”¾ stb_image åˆ†é…çš„å†…å­˜
    return 0;
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- `STB_IMAGE_IMPLEMENTATION` å¿…é¡»åœ¨åŒ…å«å¤´æ–‡ä»¶ä¹‹å‰å®šä¹‰
- `stbi_load()` è¿”å›çš„æ•°æ®æ ¼å¼æ˜¯ `RGBRGB...`ï¼Œéœ€è¦è½¬æ¢
- å¿…é¡»è°ƒç”¨ `stbi_image_free()` é‡Šæ”¾å†…å­˜

### ç¬¬å…­æ­¥ï¼šå®ç°å‹ç¼©å›¾ç‰‡ç”Ÿæˆ

åœ¨ `kmeans_with_compression()` å‡½æ•°ä¸­ï¼Œç®—æ³•å®Œæˆåï¼š

```c
// ç”Ÿæˆå‹ç¼©å›¾ç‰‡ï¼šç”¨ä¸»é¢œè‰²æ›¿æ¢åŸå›¾
compressed->width = image->width;
compressed->height = image->height;
compressed->pixels = malloc(sizeof(RgbaColor) * total);

// ç”¨å¯¹åº”çš„ä¸»é¢œè‰²æ›¿æ¢æ¯ä¸ªåƒç´ 
for (unsigned int i = 0; i < total; i++) {
    compressed->pixels[i] = centroids[labels[i]];
}
```

**åŸç†**ï¼šæ¯ä¸ªåƒç´ è¢«æ›¿æ¢ä¸ºå®ƒæ‰€å±ç°‡çš„è´¨å¿ƒé¢œè‰²ã€‚

### ç¬¬ä¸ƒæ­¥ï¼šå®ç°ç»ˆç«¯å¯è§†åŒ–

**æ–‡ä»¶**: `src/main.c`

```c
void print_compressed_image(const Image* compressed, 
                           unsigned int max_width, 
                           unsigned int max_height) {
    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
    double scale_x = (double)max_width / compressed->width;
    double scale_y = (double)max_height / compressed->height;
    double scale = scale_x < scale_y ? scale_x : scale_y;
    
    unsigned int display_width = (unsigned int)(compressed->width * scale);
    unsigned int display_height = (unsigned int)(compressed->height * scale);
    
    // æ‰“å°å›¾ç‰‡
    for (unsigned int y = 0; y < display_height; y++) {
        for (unsigned int x = 0; x < display_width; x++) {
            // è®¡ç®—åŸå›¾ä¸­å¯¹åº”çš„åƒç´ ä½ç½®
            unsigned int orig_x = (unsigned int)(x / scale);
            unsigned int orig_y = (unsigned int)(y / scale);
            unsigned int idx = orig_y * compressed->width + orig_x;
            
            const RgbaColor* color = &compressed->pixels[idx];
            
            // ä½¿ç”¨ ANSI è½¬ä¹‰åºåˆ—è®¾ç½®èƒŒæ™¯è‰²
            printf("\033[48;2;%u;%u;%um  \033[0m", 
                   color->r, color->g, color->b);
        }
        printf("\n");
    }
}
```

**ANSI è½¬ä¹‰åºåˆ—è¯´æ˜**ï¼š
- `\033[48;2;r;g;bm`: è®¾ç½®èƒŒæ™¯è‰²ï¼ˆ24ä½çœŸå½©è‰²ï¼‰
- `\033[0m`: é‡ç½®é¢œè‰²
- æ‰“å°ä¸¤ä¸ªç©ºæ ¼å½¢æˆé¢œè‰²å—ï¼ˆå› ä¸ºç»ˆç«¯å­—ç¬¦é«˜å¤§äºå®½ï¼‰

---

## ğŸ’» æ ¸å¿ƒä»£ç è§£æ

### å†…å­˜ç®¡ç†

```c
// åˆ†é…å†…å­˜
RgbaColor* centroids = malloc(sizeof(RgbaColor) * k);
unsigned int* sum_r = malloc(sizeof(unsigned int) * k);
// ... å…¶ä»–åˆ†é…

// æ£€æŸ¥åˆ†é…æ˜¯å¦æˆåŠŸ
if (!centroids || !sum_r || ...) {
    fprintf(stderr, "å†…å­˜åˆ†é…å¤±è´¥\n");
    // æ¸…ç†å·²åˆ†é…çš„å†…å­˜
    if (centroids) free(centroids);
    // ...
    return NULL;
}

// ä½¿ç”¨å®Œæ¯•åé‡Šæ”¾
free(centroids);
free(sum_r);
```

**æœ€ä½³å®è·µ**ï¼š
- æ¯æ¬¡ `malloc()` åæ£€æŸ¥è¿”å›å€¼
- åˆ†é…å¤±è´¥æ—¶æ¸…ç†å·²åˆ†é…çš„å†…å­˜
- ä½¿ç”¨å®Œæ¯•åç«‹å³é‡Šæ”¾ï¼Œé¿å…å†…å­˜æ³„æ¼

### é¿å…æ•´æ•°æº¢å‡º

```c
// âŒ é”™è¯¯ï¼šä½¿ç”¨ unsigned char ç´¯åŠ ä¼šæº¢å‡º
unsigned char sum = 0;
for (int i = 0; i < 1000; i++) {
    sum += 255;  // æº¢å‡ºï¼
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ›´å¤§çš„æ•°æ®ç±»å‹
unsigned int sum_r = 0;
for (unsigned int i = 0; i < total; i++) {
    sum_r += image->pixels[i].r;  // ä¸ä¼šæº¢å‡º
}
centroid.r = (unsigned char)(sum_r / cluster_size);  // æœ€åè½¬æ¢
```

### ç©ºç°‡å¤„ç†

```c
if (cluster_sizes[c] == 0) {
    // ç©ºç°‡ï¼šé‡æ–°éšæœºåˆå§‹åŒ–
    unsigned int idx = rand() % total;
    centroids[c] = image->pixels[idx];
    continue;
}
```

**ä¸ºä»€ä¹ˆéœ€è¦å¤„ç†ç©ºç°‡ï¼Ÿ**
- å¦‚æœæŸä¸ªè´¨å¿ƒåˆå§‹åŒ–åœ¨"åè¿œ"ä½ç½®ï¼Œå¯èƒ½æ²¡æœ‰åƒç´ è¢«åˆ†é…ç»™å®ƒ
- ç©ºç°‡ä¼šå¯¼è‡´é™¤é›¶é”™è¯¯
- é‡æ–°åˆå§‹åŒ–å¯ä»¥ç¡®ä¿æ‰€æœ‰ç°‡éƒ½æœ‰åƒç´ 

---

## ğŸ¨ åŠŸèƒ½æ‰©å±•

### 1. ä¿å­˜å‹ç¼©åçš„å›¾ç‰‡

å¯ä»¥æ·»åŠ ä¿å­˜åŠŸèƒ½ï¼Œå°†å‹ç¼©åçš„å›¾ç‰‡ä¿å­˜ä¸ºæ–‡ä»¶ï¼š

```c
// éœ€è¦æ·»åŠ  stb_image_write.h
#define STB_IMAGE_WRITE_IMPLEMENTATION
#include "../include/stb_image_write.h"

void save_compressed_image(const Image* compressed, const char* filename) {
    unsigned char* data = malloc(compressed->width * compressed->height * 3);
    
    // è½¬æ¢æ ¼å¼
    for (unsigned int i = 0; i < compressed->width * compressed->height; i++) {
        data[i * 3 + 0] = compressed->pixels[i].r;
        data[i * 3 + 1] = compressed->pixels[i].g;
        data[i * 3 + 2] = compressed->pixels[i].b;
    }
    
    stbi_write_jpg(filename, compressed->width, compressed->height, 3, data, 90);
    free(data);
}
```

### 2. K-Means++ åˆå§‹åŒ–

æ›´æ™ºèƒ½çš„åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯ä»¥é¿å…éšæœºåˆå§‹åŒ–çš„é—®é¢˜ï¼š

```c
void init_centroids_plusplus(const Image* image, RgbaColor* centroids, unsigned int k) {
    srand(time(NULL));
    
    // ç¬¬ä¸€ä¸ªè´¨å¿ƒéšæœºé€‰æ‹©
    unsigned int idx = rand() % (image->width * image->height);
    centroids[0] = image->pixels[idx];
    
    // åç»­è´¨å¿ƒé€‰æ‹©è·ç¦»å·²é€‰è´¨å¿ƒæœ€è¿œçš„ç‚¹
    for (unsigned int i = 1; i < k; i++) {
        double max_min_dist = 0;
        unsigned int best_idx = 0;
        
        for (unsigned int j = 0; j < image->width * image->height; j++) {
            double min_dist = 1e30;
            
            // æ‰¾åˆ°åˆ°å·²é€‰è´¨å¿ƒçš„æœ€å°è·ç¦»
            for (unsigned int c = 0; c < i; c++) {
                double dist = calc_dist(&image->pixels[j], &centroids[c]);
                if (dist < min_dist) {
                    min_dist = dist;
                }
            }
            
            // é€‰æ‹©æœ€å°è·ç¦»æœ€å¤§çš„ç‚¹
            if (min_dist > max_min_dist) {
                max_min_dist = min_dist;
                best_idx = j;
            }
        }
        
        centroids[i] = image->pixels[best_idx];
    }
}
```

### 3. å¤šçº¿ç¨‹ä¼˜åŒ–

ä½¿ç”¨ OpenMP å¹¶è¡Œè®¡ç®—è·ç¦»ï¼š

```c
#include <omp.h>

// åœ¨åˆ†é…é˜¶æ®µä½¿ç”¨å¹¶è¡Œ
#pragma omp parallel for
for (unsigned int i = 0; i < total; i++) {
    // ... è·ç¦»è®¡ç®—ä»£ç 
}
```

ç¼–è¯‘æ—¶æ·»åŠ  `-fopenmp` é€‰é¡¹ã€‚

---

## ğŸ¯ åº”ç”¨åœºæ™¯

### 1. å›¾ç‰‡ä¸»è‰²è°ƒæå–

```bash
./bin/kmeans image.jpg 5
```

æå–å›¾ç‰‡çš„ 5 ç§ä¸»è¦é¢œè‰²ï¼Œç”¨äºï¼š
- è®¾è®¡é…è‰²æ–¹æ¡ˆ
- å›¾ç‰‡ä¸»é¢˜åˆ†æ
- é¢œè‰²ç»Ÿè®¡

### 2. å›¾ç‰‡å‹ç¼©ï¼ˆé¢œè‰²é‡åŒ–ï¼‰

å°†å›¾ç‰‡å‹ç¼©ä¸ºåªä½¿ç”¨ K ç§é¢œè‰²ï¼š
- å‡å°‘æ–‡ä»¶å¤§å°
- åˆ›å»ºè‰ºæœ¯æ•ˆæœ
- GIF è°ƒè‰²æ¿ç”Ÿæˆ

### 3. å›¾ç‰‡åˆ†å‰²

æ ¹æ®é¢œè‰²èšç±»ç»“æœè¿›è¡Œå›¾ç‰‡åˆ†å‰²ï¼š
- å‰æ™¯/èƒŒæ™¯åˆ†ç¦»
- ç‰©ä½“è¯†åˆ«
- åŒºåŸŸæ ‡è®°

### 4. æ•°æ®å¯è§†åŒ–

åœ¨ç»ˆç«¯ä¸­ç›´æ¥æŸ¥çœ‹å›¾ç‰‡æ•ˆæœï¼Œæ— éœ€æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨ã€‚

---

## â“ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### Q1: ç¼–è¯‘é”™è¯¯ "undefined reference to sqrt"

**åŸå› **: æ²¡æœ‰é“¾æ¥æ•°å­¦åº“

**è§£å†³**: åœ¨ Makefile ä¸­æ·»åŠ  `-lm`ï¼š
```makefile
LDFLAGS = -lm
```

### Q2: ç¨‹åºè¿è¡Œå¾ˆæ…¢

**å¯èƒ½åŸå› **:
1. å›¾ç‰‡å¤ªå¤§
2. K å€¼å¤ªå¤§
3. è¿­ä»£æ¬¡æ•°å¤ªå¤š

**è§£å†³æ–¹æ¡ˆ**:
```c
// 1. ç¼©å°å›¾ç‰‡ï¼ˆåœ¨åŠ è½½æ—¶ï¼‰
// 2. å‡å° K å€¼ï¼ˆå¦‚ä» 10 æ”¹ä¸º 5ï¼‰
// 3. å¢åŠ æ”¶æ•›é˜ˆå€¼ï¼ˆå¦‚ä» 1.0 æ”¹ä¸º 2.0ï¼‰
```

### Q3: æå–çš„é¢œè‰²éƒ½æ˜¯é»‘è‰²æˆ–ç™½è‰²

**å¯èƒ½åŸå› **:
1. å›¾ç‰‡æœ¬èº«é¢œè‰²å•ä¸€
2. ç®—æ³•æœªæ­£ç¡®æ”¶æ•›
3. åˆå§‹åŒ–é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
```c
// 1. æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æ­£å¸¸åŠ è½½
// 2. å¢åŠ æœ€å¤§è¿­ä»£æ¬¡æ•°
// 3. ä½¿ç”¨ K-Means++ åˆå§‹åŒ–
// 4. å‡å°æ”¶æ•›é˜ˆå€¼
```

### Q4: å†…å­˜ä¸è¶³

**åŸå› **: å›¾ç‰‡å¤ªå¤§ï¼Œå†…å­˜åˆ†é…å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```c
// 1. ä½¿ç”¨è¾ƒå°çš„å›¾ç‰‡
// 2. åœ¨åŠ è½½æ—¶ç¼©æ”¾å›¾ç‰‡
// 3. æ£€æŸ¥ç³»ç»Ÿå¯ç”¨å†…å­˜
```

### Q5: ç»ˆç«¯çœ‹ä¸åˆ°é¢œè‰²

**åŸå› **: ç»ˆç«¯ä¸æ”¯æŒ 24 ä½çœŸå½©è‰²

**è§£å†³æ–¹æ¡ˆ**:
1. ä½¿ç”¨æ”¯æŒçœŸå½©è‰²çš„ç»ˆç«¯ï¼ˆGNOME Terminal, Konsole, iTerm2ï¼‰
2. æ£€æŸ¥ç»ˆç«¯è®¾ç½®
3. ä½¿ç”¨ RGB å’Œåå…­è¿›åˆ¶å€¼ä½œä¸ºæ›¿ä»£

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æå‰é€€å‡º

```c
if (settled) {
    printf("è¿­ä»£ %u æ¬¡åæ”¶æ•›\n", iter + 1);
    break;  // æå‰é€€å‡ºï¼ŒèŠ‚çœæ—¶é—´
}
```

### 2. å‡å°‘é‡å¤è®¡ç®—

```c
// ç¼“å­˜è·ç¦»è®¡ç®—ç»“æœï¼ˆå¦‚æœå†…å­˜å…è®¸ï¼‰
double* distances = malloc(sizeof(double) * total * k);
```

### 3. ä½¿ç”¨ SIMD æŒ‡ä»¤

ä½¿ç”¨ SIMD æŒ‡ä»¤é›†åŠ é€Ÿè·ç¦»è®¡ç®—ï¼ˆéœ€è¦ç‰¹å®š CPU æ”¯æŒï¼‰ã€‚

### 4. å¤šçº¿ç¨‹å¹¶è¡Œ

ä½¿ç”¨ OpenMP æˆ– pthread å¹¶è¡Œå¤„ç†åƒç´ åˆ†é…ã€‚

---

## ğŸ“ å¼€å‘æ€»ç»“

### å…³é”®å­¦ä¹ ç‚¹

1. **ç®—æ³•ç†è§£**: K-Means çš„æ ¸å¿ƒæ˜¯è¿­ä»£ä¼˜åŒ–
2. **å†…å­˜ç®¡ç†**: C è¯­è¨€éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œæ³¨æ„åˆ†é…å’Œé‡Šæ”¾
3. **ç±»å‹è½¬æ¢**: æ³¨æ„æ•´æ•°æº¢å‡ºï¼Œä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹
4. **é”™è¯¯å¤„ç†**: æ£€æŸ¥æ‰€æœ‰å¯èƒ½å¤±è´¥çš„æ“ä½œï¼ˆå†…å­˜åˆ†é…ã€æ–‡ä»¶åŠ è½½ç­‰ï¼‰
5. **å¯è§†åŒ–**: ANSI è½¬ä¹‰åºåˆ—å¯ä»¥å®ç°ä¸°å¯Œçš„ç»ˆç«¯è¾“å‡º

### ä¸‹ä¸€æ­¥æ”¹è¿›æ–¹å‘

1. âœ… å®ç°åŸºç¡€ K-Means ç®—æ³•
2. âœ… æ·»åŠ å›¾ç‰‡åŠ è½½åŠŸèƒ½
3. âœ… å®ç°ç»ˆç«¯å¯è§†åŒ–
4. ğŸ”„ æ·»åŠ  K-Means++ åˆå§‹åŒ–
5. ğŸ”„ å®ç°å›¾ç‰‡ä¿å­˜åŠŸèƒ½
6. ğŸ”„ æ·»åŠ å¤šçº¿ç¨‹æ”¯æŒ
7. ğŸ”„ ä¼˜åŒ–æ€§èƒ½ï¼ˆSIMDã€ç¼“å­˜ç­‰ï¼‰

---

## ğŸ“ å‚è€ƒèµ„æ–™

- [K-Means ç®—æ³•åŸç†](https://en.wikipedia.org/wiki/K-means_clustering)
- [stb_image æ–‡æ¡£](https://github.com/nothings/stb)
- [ANSI è½¬ä¹‰åºåˆ—](https://en.wikipedia.org/wiki/ANSI_escape_code)
- [C è¯­è¨€å†…å­˜ç®¡ç†æœ€ä½³å®è·µ](https://en.wikipedia.org/wiki/C_dynamic_memory_allocation)

---

**ç¥ä½ å¼€å‘é¡ºåˆ©ï¼å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æŸ¥é˜…ä»£ç æ³¨é‡Šæˆ–æå‡º Issueã€‚**

