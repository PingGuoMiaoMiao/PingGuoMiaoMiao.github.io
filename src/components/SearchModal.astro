---
// Ëé∑ÂèñÊâÄÊúâÊñáÁ´†Áî®‰∫éÊêúÁ¥¢
const allPostsRaw = await Astro.glob('../content/posts/*.md');
const searchPostsData = allPostsRaw.map((p: any) => ({
  url: `/post/${p.file.split('/').pop()?.replace('.md', '')}`,
  title: p.frontmatter.title || '',
  desc: p.frontmatter.summary || p.frontmatter.description || '',
  tag: p.frontmatter.tag || '',
}));
---

<button id="openSearch" class="open-search" aria-label="ÊêúÁ¥¢" data-search-modal>üîç</button>
<dialog id="searchModal">
  <form method="dialog" class="modal">
    <input id="searchInput" placeholder="ÊêúÁ¥¢Ê†áÈ¢òÊàñÊèèËø∞‚Ä¶" />
    <div id="searchList" class="list"></div>
    <div class="actions">
      <button value="close" class="neo-btn" style="background-color: var(--neo-primary); color: var(--neo-black);">ÂÖ≥Èó≠</button>
    </div>
  </form>
  <script type="application/json" id="searchData" is:inline>
    {JSON.stringify(searchPostsData)}
  </script>
</dialog>

<style>
  .open-search { 
    position: fixed; 
    right: 16px; 
    bottom: 120px; 
    width: 50px; 
    height: 50px; 
    border-radius: 50%; 
    border: 4px solid var(--neo-black);
    color: var(--neo-black); 
    background: var(--neo-white);
    box-shadow: var(--neo-shadow);
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 150;
    transition: transform var(--neo-transition), box-shadow var(--neo-transition);
  }
  
  .open-search:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0 var(--neo-black);
  }
  
  dialog { 
    border: none; 
    background: transparent; 
  }
  
  .modal { 
    width: min(720px, 92vw); 
    margin: 10vh auto; 
    background: var(--neo-white);
    color: var(--neo-black); 
    padding: 2rem; 
    border-radius: var(--neo-radius);
    border: 4px solid var(--neo-black);
    box-shadow: var(--neo-shadow);
  }
  
  input { 
    width: 100%; 
    padding: 0.9rem 1rem; 
    border-radius: var(--neo-radius);
    border: 4px solid var(--neo-black);
    background: var(--neo-white);
    color: var(--neo-black);
    font-family: inherit;
    font-size: 1rem;
  }
  
  input:focus {
    outline: none;
    border-color: var(--neo-primary-dark);
    box-shadow: 6px 6px 0 var(--neo-black);
  }
  
  .list { 
    display: grid; 
    gap: 0.75rem; 
    margin-top: 1rem; 
    max-height: 50vh; 
    overflow: auto; 
  }
  
  .item { 
    display: flex; 
    flex-direction: column;
    gap: 0.25rem;
    padding: 1rem; 
    border-radius: var(--neo-radius);
    border: 3px solid var(--neo-black);
    background: var(--neo-white);
    text-decoration: none; 
    color: var(--neo-black);
    transition: transform var(--neo-transition), box-shadow var(--neo-transition);
  }
  
  .item:hover {
    transform: translate(-2px, -2px);
    box-shadow: 4px 4px 0 var(--neo-black);
  }
  
  .item-title {
    font-weight: 700;
    font-size: 1.1rem;
  }
  
  .item-desc {
    font-size: 0.9rem;
    color: var(--neo-gray-700);
  }
  
  .actions { 
    display: flex; 
    justify-content: flex-end; 
    margin-top: 1rem; 
  }
  
  @media (max-width: 768px) {
    .open-search {
      width: 45px;
      height: 45px;
      right: 12px;
      bottom: 100px;
      font-size: 1.1rem;
      border-width: 3px;
    }
    
    .modal {
      width: 95vw;
      margin: 5vh auto;
      padding: 1.5rem;
      border-width: 3px;
    }
    
    input {
      padding: 0.75rem 0.9rem;
      font-size: 0.95rem;
      border-width: 3px;
    }
    
    .list {
      max-height: 60vh;
      gap: 0.6rem;
    }
    
    .item {
      padding: 0.75rem;
      border-width: 2px;
    }
    
    .item-title {
      font-size: 1rem;
    }
    
    .item-desc {
      font-size: 0.85rem;
    }
    
    .neo-btn {
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
    }
  }
  
  @media (max-width: 480px) {
    .open-search {
      width: 40px;
      height: 40px;
      right: 10px;
      bottom: 90px;
      font-size: 1rem;
      border-width: 3px;
    }
    
    .modal {
      width: 98vw;
      margin: 2vh auto;
      padding: 1rem;
    }
    
    input {
      padding: 0.65rem 0.8rem;
      font-size: 0.9rem;
    }
    
    .list {
      max-height: 65vh;
      gap: 0.5rem;
    }
    
    .item {
      padding: 0.6rem;
    }
    
    .item-title {
      font-size: 0.95rem;
    }
    
    .item-desc {
      font-size: 0.8rem;
    }
    
    .neo-btn {
      padding: 0.65rem 1rem;
      font-size: 0.85rem;
    }
  }
</style>

<script is:inline>
  const bind = () => {
    const btn = document.getElementById('openSearch');
    const modal = document.getElementById('searchModal');
    const input = document.getElementById('searchInput');
    const list = document.getElementById('searchList');
    const raw = document.getElementById('searchData');
    if (!btn || !modal || !input || !list || !raw) return;
    const data = JSON.parse(raw.textContent || '[]');
    btn.addEventListener('click', () => modal.showModal());
    const render = (q) => {
      const k = (q || '').toLowerCase();
      const arr = k ? data.filter((d) => 
        d.title.toLowerCase().includes(k) || 
        d.desc.toLowerCase().includes(k) ||
        d.tag.toLowerCase().includes(k)
      ) : data.slice(0, 20);
      list.innerHTML = '';
      arr.forEach((d) => {
        const a = document.createElement('a');
        a.href = d.url;
        a.className = 'item';
        a.innerHTML = `
          <span class="item-title">${escapeHtml(d.title)}</span>
          ${d.desc ? `<span class="item-desc">${escapeHtml(d.desc)}</span>` : ''}
        `;
        list.appendChild(a);
      });
    };
    input.addEventListener('input', (e) => render(e.target.value));
    render('');
  };
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  document.addEventListener('astro:page-load', bind);
  document.addEventListener('astro:after-swap', bind);
  if (document.readyState === 'complete') bind();
</script>
