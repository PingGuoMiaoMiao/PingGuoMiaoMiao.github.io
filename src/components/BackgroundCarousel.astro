
---

// BackgroundCarousel.astro
const slides = [
    {
        image: "wallhaven-5g99w9_3840x1600.png",
        text: 'First Slide',
    },
    {
        image: 'wallhaven-jxkrzy_3840x1600.png',
        text: 'Second Slide',
    },
    {
        image: 'wallhaven-we7767_3440x1440.png',
        text: 'Third Slide',
    },
    {
        image: '小南娘图.jpg',
        text: 'Fourth Slide',
    },
];
---

<div class="carousel">
    {slides.map((slide, index) => {
        // 对中文文件名进行 URL 编码
        const encodedImage = encodeURI(slide.image);
        const isFirst = index === 0;
        return (
            <div 
                class={`carousel-slide ${isFirst ? 'active' : ''}`} 
                data-slide-index={index}
                style={isFirst ? `background-image: url("/${encodedImage}");` : undefined}
                data-bg-image={!isFirst ? `/${encodedImage}` : undefined}
            >
            <div class="text">{slide.text}</div>
        </div>
        );
    })}
    <div class="backdrop-overlay"></div>
</div>

<style>
    .carousel {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        width: 100%;
        overflow: hidden;
        z-index: -1;
    }

    .carousel-slide {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        opacity: 0;
        transition: opacity 1s ease-in-out;
        filter: brightness(0.9) saturate(1.1) blur(2px);
        will-change: opacity;
        transform: translateZ(0); /* 启用硬件加速 */
        contain: layout style paint; /* CSS containment 优化 */
    }

    .carousel-slide.active {
        opacity: 1;
    }
    
    /* 移动端优化：减少模糊效果以提升性能 */
    @media (max-width: 768px) {
        .carousel-slide {
            filter: brightness(0.9) saturate(1.1);
            transition: opacity 0.8s ease-in-out;
        }
    }
    
    /* 低性能设备优化 */
    @media (prefers-reduced-motion: reduce) {
        .carousel-slide {
            transition: none;
        }
    }

    .text {
        position: absolute;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        color: rgba(255,255,255,.9);
        font-size: clamp(1.25rem, 2.5vw, 2rem);
        text-shadow: 0 4px 18px rgba(0, 0, 0, 0.55);
        letter-spacing: .25px;
    }
    
    .backdrop-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(248, 248, 248, 0.85);
        pointer-events: none;
        z-index: 0;
    }
</style>

<script is:inline>
    (function() {
        let carouselInterval = null;
    let currentSlide = 0;

        // 延迟加载背景图片
        function loadSlideBackground(slide) {
            const bgImage = slide.getAttribute('data-bg-image');
            if (bgImage && !slide.style.backgroundImage) {
                // 使用 requestIdleCallback 在浏览器空闲时加载
                if ('requestIdleCallback' in window) {
                    requestIdleCallback(function() {
                        slide.style.backgroundImage = 'url("' + bgImage + '")';
                    }, { timeout: 2000 });
                } else {
                    // 降级方案：延迟加载
                    setTimeout(function() {
                        slide.style.backgroundImage = 'url("' + bgImage + '")';
                    }, 1000);
                }
            }
        }

        function initCarousel() {
            // 清除之前的定时器
            if (carouselInterval !== null) {
                clearInterval(carouselInterval);
                carouselInterval = null;
            }

    const slides = document.querySelectorAll('.carousel-slide');
    const totalSlides = slides.length;

            if (totalSlides === 0) {
                console.warn('No carousel slides found');
                return;
            }

            // 重置当前幻灯片索引
            currentSlide = 0;
            
            // 确保第一个幻灯片是激活的，并预加载下一张
            slides.forEach(function(slide, index) {
                if (index === 0) {
                    slide.classList.add('active');
                } else {
                    slide.classList.remove('active');
                    // 预加载下一张图片
                    if (index === 1) {
                        loadSlideBackground(slide);
                    }
                }
            });

            function showSlide(index) {
                if (slides[currentSlide]) {
        slides[currentSlide].classList.remove('active');
                }
        currentSlide = (index + totalSlides) % totalSlides;
                if (slides[currentSlide]) {
                    // 加载当前幻灯片背景（如果还没加载）
                    loadSlideBackground(slides[currentSlide]);
        slides[currentSlide].classList.add('active');
                    
                    // 预加载下一张
                    const nextIndex = (currentSlide + 1) % totalSlides;
                    if (slides[nextIndex]) {
                        loadSlideBackground(slides[nextIndex]);
                    }
                }
            }

            function nextSlide() {
                showSlide(currentSlide + 1);
            }

            // 使用 requestIdleCallback 延迟启动轮播（如果支持）
            function startCarousel() {
                carouselInterval = setInterval(nextSlide, 5000);
            }

            if ('requestIdleCallback' in window) {
                requestIdleCallback(startCarousel, { timeout: 3000 });
            } else {
                // 降级：延迟启动
                setTimeout(startCarousel, 1000);
            }
        }

        // 等待 DOM 加载完成
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCarousel);
        } else {
            // DOM 已经加载完成，立即初始化
            setTimeout(initCarousel, 100);
        }

        // 支持 Astro 的页面切换
        document.addEventListener('astro:page-load', initCarousel);
        document.addEventListener('astro:after-swap', initCarousel);
    })();
</script>