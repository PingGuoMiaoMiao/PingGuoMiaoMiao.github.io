---
import BaseLayout from '../../layouts/BaseLayout.astro';
import PostCard from '../../components/PostCard.astro';
import type { MarkdownInstance } from 'astro';

// 1. 定义类型接口
interface Frontmatter {
  title: string;
  description?: string;
  pubDate: string | Date;
  tags?: string[];
  image?: string;
  [key: string]: any; // 其他可能的属性
}

interface Post extends MarkdownInstance<Frontmatter> {
  url: string;
}

// 2. 定义 getStaticPaths 的返回类型
interface StaticPath {
  params: { tag: string };
  props: { posts: Post[] };
}

export async function getStaticPaths(): Promise<StaticPath[]> {
  const allPosts = (await Astro.glob<Frontmatter>('../posts/*.md')) as Post[];
  
  // 3. 收集所有唯一的标签
  const tagSet = new Set<string>();
  allPosts.forEach(post => {
    (post.frontmatter.tags || []).forEach(tag => tagSet.add(tag));
  });
  const uniqueTags = Array.from(tagSet);

  return uniqueTags.map(tag => {
    const filteredPosts = allPosts.filter(post => 
      (post.frontmatter.tags || []).includes(tag)
    );
    
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

// 4. 明确指定类型
const params = Astro.params as { tag: string };
const props = Astro.props as { posts: Post[] };

const tag = params.tag;
const { posts } = props;
---