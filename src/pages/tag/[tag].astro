---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { processPosts, getPostsByTag, getAllTags } from '../../utils/posts';

export async function getStaticPaths() {
  // 获取所有文章
  const allPostsRaw = await Astro.glob('../../content/posts/*.md');
  const allPosts = processPosts(allPostsRaw);
  
  // 获取所有标签
  const tags = getAllTags(allPosts);
  
  // 为每个标签生成路径
  return tags.map((tag) => {
    const posts = getPostsByTag(allPosts, tag);
    // 只生成有文章的标签页
    if (posts.length === 0) {
      return null;
    }
    // 使用原始标签名作为参数，Astro 会自动处理编码
    return {
      params: { tag },
      props: { tag, posts },
    };
  }).filter(Boolean);
}

interface Props {
  tag: string;
  posts: ReturnType<typeof processPosts>;
}

const { tag: decodedTag, posts } = Astro.props;
const pageTitle = `标签: ${decodedTag} | 苹果喵喵Blog`;
---

<BaseLayout pageTitle={pageTitle}>
  <section class="neo-page">
    <div class="neo-card neo-brutalist neo-card-container">
      <header class="neo-card-header">
        <h3>标签: {decodedTag}</h3>
        <p>共 {posts.length} 篇文章</p>
      </header>
      <div class="neo-card-body">
        <div class="posts-list">
          {posts.map((post) => (
            <article class="post-item neo-brutalist">
              <header class="post-item-header">
                <h2 class="post-item-title">
                  <a href={post.url}>{post.frontmatter.title}</a>
                </h2>
                <div class="post-item-meta">
                  <time>{new Date(post.frontmatter.date).toLocaleDateString('zh-CN')}</time>
                  <span> · </span>
                  <a href={`/tag/${encodeURIComponent(post.frontmatter.tag)}`} class="post-item-tag">
                    {post.frontmatter.tag}
                  </a>
                </div>
              </header>
              {post.frontmatter.summary && (
                <p class="post-item-excerpt">{post.frontmatter.summary}</p>
              )}
            </article>
          ))}
        </div>
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .neo-page {
    min-height: 80vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 2rem 1rem 4rem;
  }
  
  .neo-card-container {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding: 2rem;
    width: 100%;
    max-width: 960px;
  }
  
  .neo-card-header h3 {
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 0.05em;
    font-size: 2rem;
    margin: 0;
    color: var(--neo-black);
  }
  
  .neo-card-header p {
    margin: 0.25rem 0 0;
    color: var(--neo-gray-700);
    font-size: 0.95rem;
  }
  
  .posts-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .post-item {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: transform var(--neo-transition), box-shadow var(--neo-transition);
  }
  
  .post-item:hover {
    box-shadow: 6px 6px 0 var(--neo-black);
    transform: translate(2px, 2px);
  }
  
  .post-item-header {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .post-item-title {
    margin: 0;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
  }
  
  .post-item-title a {
    color: var(--neo-black);
    text-decoration: none;
  }
  
  .post-item-title a:hover {
    color: var(--neo-primary-dark);
  }
  
  .post-item-meta {
    display: flex;
    align-items: center;
    gap: 0.35rem;
    color: var(--neo-gray-700);
    font-size: 0.9rem;
  }
  
  .post-item-tag {
    color: var(--neo-primary-dark);
    text-decoration: none;
    font-weight: 600;
  }
  
  .post-item-tag:hover {
    text-decoration: underline;
  }
  
  .post-item-excerpt {
    margin: 0;
    color: var(--neo-gray-700);
    line-height: 1.6;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
